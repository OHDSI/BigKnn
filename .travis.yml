# Use container-based Travis with caching

languague: c
sudo: false

addons:
  apt:
    sources:
    - r-packages-precise
    packages:
    - r-base-dev
    - r-recommended
    - texinfo
    - qpdf
    - default-jdk
    - default-jre
    
cache:
  directories:
    - ~/Rlib     # R libraries
    - ~/texlive  # LaTex 
    - ~/bin      # pandoc 

# install dependencies
install:
  # Save R packages in Rlib
  - mkdir -p ~/Rlib
  - echo 'R_LIBS=~/Rlib' > .Renviron
  - echo 'options(repos = "http://cran.rstudio.com")' > .Rprofile
  
  - mkdir -p ~/.R
  - grep '\-g'  /etc/R/Makeconf | sed 's/-g//g' > ~/.R/Makevars # Turn off debug symbols
  # Build LaTex and pandoc
  - mkdir -p ~/bin
  - wget -q -O - https://github.com/yihui/crandalf/raw/master/inst/scripts/install-texlive | bash
  - wget -q -O - https://github.com/yihui/crandalf/raw/master/inst/scripts/install-pandoc | bash
  - PATH=$HOME/texlive/bin/x86_64-linux:$PATH  
  # Install drat
  - Rscript -e "if (!require('drat')) install.packages('drat')"   
  - echo 'drat::addRepo("OHDSI")' >> .Rprofile    
  # Install R packages
  - Rscript -e "if (!require('devtools')) install.packages('devtools')"    
#  - Rscript -e "if (!require('covr')) devtools::install_github('jimhester/covr')"  
#  - Rscript -e "if (!require('rmarkdown')) install.packages('rmarkdown')"
#  - Rscript -e "if (!require('knitr')) install.packages('knitr')"       
  - Rscript -e "if (!require('rJava')) install.packages('rJava')"
  - Rscript -e "if (!require('PatientLevelPrediction')) install.packages('PatientLevelPrediction')"  # Using drat, should install dependencies
  - Rscript -e "if (!require('OhdsiRTools')) install.packages('OhdsiRTools')"
    
 # Build and check package
script:
  - R CMD build .
  - PKG_FILE_NAME=$(ls -1t *.tar.gz | head -n 1)
  - PKG_NAME=$(ls -1t *.tar.gz | head -n 1 | sed 's/_.*gz//')
  - _R_CHECK_CRAN_INCOMING_=FALSE R CMD check "${PKG_FILE_NAME}" --as-cran
  - cat ${PKG_NAME}.Rcheck/00install.out # Print out install / compile log 

after_success:
#  - Rscript -e 'covr::codecov()'
  # Rebuild docker container
  - curl --data "build=true" -X POST https://registry.hub.docker.com/u/ohdsi/development/trigger/e51f720d-c4e7-45df-b042-5d8a362bd7e0/
  # Rebuild drat repo   
  - export PKG_TARBALL=$(Rscript -e 'pkg <- devtools::as.package("."); cat(paste0(pkg$package,"_",pkg$version,".tar.gz"))')    
  - test $TRAVIS_PULL_REQUEST == "false" && test $TRAVIS_BRANCH == "master" && bash deploy_container.sh
  
notifications:
  recipients:
    - msuchard@gmail.com
    - schuemie@ohdsi.org
  email:
    on_success: change
    on_failure: always
    
env:
  global:
#     - R_BUILD_ARGS=" " 
#     - R_CHECK_ARGS="--as-cran"  
  - secure: jZgQGkq4/DVXfm7523t0RBcHVWlVfTfW8u/wEBPvsBEVO63vpF64QrseulZo5wrcIwhlqrW35lZtn8uPJHmPVW83NocM4uOBrx3T7RuB8EbdarudNmcQ9R0ehLT2cdckjTvVvXRj6N7SjMTT0YlOR1caTHsVqxCkvVjYrGJDss1maJHvUMGkYZqM5WYOaV3kCjJgyTaNh/SxqCA6QZGXiv0EWc/WiuSVam3UzEciBToC9KKBhBZ3WESPRY1PxsGLX/MO5V5nKZ56gV0FphD4xSxycFwo7TvN3BFW8MHZPrp4zBaf2iZajayhQYa+WIIrfJZrZvANHANzuEjoVksCz17bjHJ3KHOdOwod7I4G4olaqW7WoqDNPX2IIhFeUWFQxJT3WexNeieevZq+RQLKeOejNvuQWycy9ZQYY3P06haKahAt3zbNLQ3Sk0mhSl/+BS29aEqtQ0jWo4CLi/uqmuQj+0I8ZzziIj375nYNYI6/APom6MQllWNybYwuNWZ8nh6k3xhS+lgCLbe/AahCRgGBa1TAsAvQWbq7dYsvz+5cZWoJRwUCbCGe9WXlDrlxnFGSjUxqlCWl7o20prSme6PDGcefDS9TPpwMhoErx1Mg+nza6kiVk1zxrSl8n06Z2L77QhEfezigJZnASrs6GU1Oa7/UBjG1mpQyoLnMw7Y=
    